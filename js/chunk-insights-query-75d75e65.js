System.register(["./chunk-frameworks.js","./chunk-vendor.js"],function(){"use strict";var g,y;return{setters:[function(u){g=u.a,y=u.k},function(){}],execute:function(){function u(o="Error loading data",e="Unable to render chart."){return`<div class="blankslate color-bg-tertiary rounded-1 d-flex flex-column flex-items-center flex-justify-center height-full">
  <svg
    aria-hidden="true"
    height="24"
    viewBox="0 0 24 24"
    version="1.1"
    width="24"
    class="octicon octicon-graph blankslate-icon"
  >
    <path d="M2.5 2.75a.75.75 0 00-1.5 0v18.5c0 .414.336.75.75.75H20a.75.75 0 000-1.5H2.5V2.75z"></path>
    <path
      d="M22.28 7.78a.75.75 0 00-1.06-1.06l-5.72 5.72-3.72-3.72a.75.75 0 00-1.06 0l-6 6a.75.75 0 101.06 1.06l5.47-5.47 3.72 3.72a.75.75 0 001.06 0l6.25-6.25z"
    ></path>
  </svg>

  <h3 class="mb-1">${o}</h3>

  <p>${e}</p>
</div>`}const h="insights-query-datadog-telemetry",a={bubbles:!0,cancelable:!0};class m extends HTMLElement{constructor(){super(...arguments),this.currentQueryId=0}connectedCallback(){this.executeQuery()}static get observedAttributes(){return["query","api-url","auth-url"]}attributeChangedCallback(){this.autoRender&&this.executeQuery()}get autoRender(){return this.hasAttribute("auto-render")}set autoRender(e){e?this.setAttribute("auto-render",""):this.removeAttribute("auto-render")}get query(){let e=this.getAttribute("query");if(e)return e;const t=this.getAttribute("query-container-id");if(t){const r=document.getElementById(t);r&&(e=r instanceof HTMLInputElement?r.value:r.textContent)}return e}set query(e){e?this.setAttribute("query",e):this.removeAttribute("query")}get apiUrl(){return this.getAttribute("api-url")}set apiUrl(e){e?this.setAttribute("api-url",e):this.removeAttribute("api-url")}get authUrl(){return this.getAttribute("auth-url")}set authUrl(e){e?this.setAttribute("auth-url",e):this.removeAttribute("auth-url")}async executeQuery(){const e=new Date().getTime(),{query:t,render:r,config:i,queryScope:n}=this.parseQuery(),s=this.apiUrl;if(!s||!t||!r)return;const c=["series-table","line-chart","stacked-area-chart","bar-chart","column-chart"];if(this.children.length===0){if(!c.includes(r))throw this.innerHTML=u(),this.dispatchEvent(new CustomEvent(h,Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-error"}}))),new l(`Query contains unknown render type: ${r}`);this.appendChild(document.createElement(r))}if(!this.isValidQueryScope(n))throw this.innerHTML=u(),this.dispatchEvent(new CustomEvent(h,Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-error"}}))),new l(`Query contains invalid scope: ${n}`);const d=this.currentQueryId+1;this.currentQueryId=d,this.renderLoading(d);const E=new Date().getTime(),{token:b,authScope:w,organization:v}=await this.fetchTokenAndAuthScope(),A=new Date().getTime();b&&w&&v&&await this.fetchQuery({authQueryTime:A-E,apiUrl:s,organization:v,query:t,queryScope:n,authScope:w,startTime:e,token:b,queryId:d,config:i})}async fetchQuery(e){try{const t=new Date().getTime(),r=await fetch(e.apiUrl,{method:"POST",body:JSON.stringify({query:e.query,queryScope:e.queryScope}),headers:{Authorization:e.token,"X-Auth-Scope":e.authScope,"Content-Type":"application/json"}}),i=new Date().getTime();if(r.status!==200)throw new Error(`Insights API returned status code: ${r.status}`);const n=await r.json(),{data:s,errors:c}=n;if(!s||!c)throw new Error("Either no data is returned or data response has changed");if(c&&c.hasErrors)throw new Error(`Insights API Error: ${c.errorMessage}`);this.renderSeries(e.queryId,s,e.config,s.isSensitive);const d=new Date().getTime();this.dispatchEvent(new CustomEvent(h,Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-success"}}))),this.dispatchEvent(new CustomEvent("insights-query-hydro-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-success",context:{organization:e.organization,"insights.render.time":d-e.startTime,"api.query.time":i-t,"auth.query.time":e.authQueryTime}}})))}catch(t){const r=t;throw this.dispatchEvent(new CustomEvent(h,Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-error"}}))),this.dispatchEvent(new CustomEvent("insights-query-hydro-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-error",context:{organization:e.organization,"auth.query.time":e.authQueryTime}}}))),this.renderError(e.queryId),new f(r.message)}}async fetchTokenAndAuthScope(){const e=this.authUrl;if(!e)return{token:null,authScope:null,organization:null};try{const t=await fetch(e,{headers:{Accept:"application/json"}}),{token:r,authScope:i,organization:n}=await t.json();return{token:r,authScope:i,organization:n}}catch(t){const r=t;throw this.dispatchEvent(new CustomEvent(h,Object.assign(Object.assign({},a),{detail:{incrementKey:"token-fetch-error"}}))),this.dispatchEvent(new CustomEvent("insights-query-hydro-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"token-fetch-error"}}))),new p(r.message)}}parseQuery(){const e=this.query;if(!e)return{query:null,render:null,config:null,queryScope:null};const t=e.match(/--\s*render\s+(?<render>[a-z-]+)\s?(?<config>\([^)]*\))?/i),r=t&&t.groups!==void 0?t.groups.render:"series-table",i=t&&t.groups!==void 0&&t.groups.config!==void 0?this.parseConfig(t.groups.config):null,n=e.match(/--\s*scope\s+(?<scope>[^\s]+)/i);return{query:e,render:r,config:i,queryScope:n&&n.groups!==void 0?n.groups.scope:null}}parseConfig(e){const t=(e=e.trim()).substring(1,e.length-1).split(/\r\n|\n|\r/),r={};for(const i of t){const[n,s]=i.split(":").map(c=>c.trim());n&&(r[n]=s||!0)}return r}isValidQueryScope(e){return e==null||/^project\/\d+$/.test(e)}renderError(e,t){if(this.currentQueryId===e)for(const r of Array.from(this.children))r.setAttribute("error",encodeURI(t||"")),r.removeAttribute("loading"),r.removeAttribute("masked")}renderLoading(e){if(this.currentQueryId===e)for(const t of Array.from(this.children))t.setAttribute("loading",""),t.removeAttribute("error"),t.removeAttribute("masked")}renderSeries(e,t,r,i){if(this.currentQueryId!==e)return;const n=encodeURI(JSON.stringify(t));for(const s of Array.from(this.children))i?s.setAttribute("masked",""):s.removeAttribute("masked"),s.setAttribute("series",n),s.removeAttribute("loading"),s.removeAttribute("error"),r&&r["chart-stacked"]===!0?s.setAttribute("chart-stacked",""):s.removeAttribute("chart-stacked")}}class p extends Error{constructor(e){super(e),this.name="InsightsTokenFetchError"}}class f extends Error{constructor(e){super(e),this.name="InsightsDataFetchError"}}class l extends Error{constructor(e){super(e),this.name="InsightsQueryStatementError"}}window.customElements.get("insights-query")||(window.InsightsQueryElement=m,window.InsightsTokenFetchError=p,window.InsightsDataFetchError=f,window.InsightsQueryStatementError=l,window.customElements.define("insights-query",m)),window.addEventListener("insights-query-datadog-telemetry",o=>{const e=o,t={};let r=e.detail.incrementKey;if(r){r=`INSIGHTS_QUERY_${r.replace(/-/g,"_").toUpperCase()}`;const i=r;i&&(t.incrementKey=i)}Object.keys(t).length>0&&g(t)}),window.addEventListener("insights-query-hydro-telemetry",o=>{const e=o;let t=e.detail.incrementKey;t&&(t=`INSIGHTS_QUERY_${t.replace(/-/g,"_").toUpperCase()}`),y(t,e.detail.context||{})})}}});
//# sourceMappingURL=chunk-insights-query-5eb9d20c.js.map
